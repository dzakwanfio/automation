{% extends 'base2.html' %}
{% load static %}

{% block title %}Generate Document{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'style/generate_document.css' %}">
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="fw-bold">Generate Document</h2>
    <div class="card shadow-sm">
        <div class="card-header bg-teal text-white d-flex justify-content-between align-items-center">
            <span class="fw-bold" style="font-size: 18px;">Manage Files</span>
            <div>
                <label for="search" class="me-2" style="font-size: 16px;">Search:</label>
                <input type="text" id="search" class="form-control d-inline-block" 
                    style="width: 150px; font-size: 12px; padding: 4px 8px; height: auto;" 
                    placeholder="search" 
                    oninput="searchData()">
            </div>
        </div>
        <div class="card-body">
            <table class="table table-hover">
                <thead class="border-bottom">
                    <tr class="text-center">
                        <th>
                            <input type="checkbox" id="select-all">
                            <span id="selected-count" style="font-size: 12px; margin-left: 5px; color: gray;">0</span>
                        </th>
                        <th onclick="sortTable(1, this)" data-sort="asc">
                            Name <i class="fas fa-sort"></i>
                        </th>
                        <th>Email</th>
                        <th>Handphone</th>
                        <th>City</th>
                    </tr>
                </thead>
                <tbody id="table-body">
                    {% for peserta in files %}
                    <tr class="text-center">
                        <td><input type="checkbox" class="row-checkbox" value="{{ peserta.id }}"></td>
                        <td class="name-cell">{{ peserta.nama }}</td>
                        <td>{{ peserta.email|default:"-" }}</td>
                        <td>{{ peserta.nomor_hp }}</td>
                        <td>{{ peserta.kota|default:"-" }}</td>
                    </tr>
                    {% empty %}
                    <tr class="text-center">
                        <td colspan="5">Tidak ada data tersedia</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            <p id="no-results" class="text-center text-danger mt-3" style="display: none;">Tidak ada hasil yang cocok</p>

            <div class="pagination-container mb-4">
                <button class="btn-pagination prev-btn" disabled>Previous</button>
                <span class="pagination-number">1</span>
                <button class="btn-pagination next-btn">Next</button>
            </div>

            <div class="d-flex justify-content-end mt-5">
                <button id="convertDocument" class="btn btn-success submit-btn">Convert</button>
            </div>
        </div>
    </div>
</div>

<script>
// Checkbox Select All & Update Selected Count
document.getElementById("select-all").addEventListener("change", function() {
    let checkboxes = document.querySelectorAll(".row-checkbox");
    checkboxes.forEach(checkbox => {
        checkbox.checked = this.checked;
    });
    updateSelectedCount();
});

document.querySelectorAll(".row-checkbox").forEach(checkbox => {
    checkbox.addEventListener("change", updateSelectedCount);
});

function updateSelectedCount() {
    let selected = document.querySelectorAll(".row-checkbox:checked").length;
    document.getElementById("selected-count").textContent = selected;
}

// Fungsi untuk mencari data di seluruh kolom tabel
function searchData() {
    console.log("searchData() terpanggil");
    let input = document.getElementById("search").value.toLowerCase();
    let rows = document.querySelectorAll("#table-body tr");
    let noResults = document.getElementById("no-results");
    let found = false;

    rows.forEach(row => {
        let cells = row.querySelectorAll("td");
        let rowText = "";
        cells.forEach(cell => {
            rowText += cell.textContent.toLowerCase() + " ";
        });

        if (rowText.includes(input)) {
            row.dataset.match = "true";
            row.style.display = "";
            found = true;
        } else {
            row.dataset.match = "false";
            row.style.display = "none";
        }
    });

    noResults.style.display = found ? "none" : "block";
    showPage(1);
}

// Sorting Table
function sortTable(columnIndex, header) {
    let table = document.querySelector("#table-body");
    let rows = Array.from(table.rows);
    let isAscending = header.getAttribute("data-sort") === "asc";

    rows.sort((rowA, rowB) => {
        let cellA = rowA.cells[columnIndex].textContent.trim().toLowerCase();
        let cellB = rowB.cells[columnIndex].textContent.trim().toLowerCase();

        if (isAscending) {
            return cellA.localeCompare(cellB);
        } else {
            return cellB.localeCompare(cellB);
        }
    });

    table.innerHTML = "";
    rows.forEach(row => table.appendChild(row));

    header.setAttribute("data-sort", isAscending ? "desc" : "asc");
    updateSortIcons(header, isAscending);

    showPage(currentPage);
}

function updateSortIcons(header, isAscending) {
    document.querySelectorAll("th i").forEach(icon => {
        icon.classList.remove("fa-sort-up", "fa-sort-down");
        icon.classList.add("fa-sort");
        icon.style.color = "#6c757d";
    });

    let icon = header.querySelector("i");
    icon.classList.remove("fa-sort");
    icon.classList.add(isAscending ? "fa-sort-up" : "fa-sort-down");
    icon.style.color = "#007bff";
}

// Pagination
let currentPage = 1;
const rowsPerPage = 10;

function showPage(page) {
    let allRows = Array.from(document.querySelectorAll("#table-body tr"));
    let filteredRows = allRows.filter(row => row.dataset.match !== "false");

    let totalPages = Math.ceil(filteredRows.length / rowsPerPage) || 1;
    if (page > totalPages) page = totalPages;
    if (page < 1) page = 1;
    currentPage = page;

    filteredRows.forEach((row, index) => {
        row.style.display = (index >= (page - 1) * rowsPerPage && index < page * rowsPerPage) ? "" : "none";
    });

    document.querySelector(".pagination-number").textContent = page;
    document.querySelector(".prev-btn").disabled = (page === 1);
    document.querySelector(".next-btn").disabled = (page === totalPages);
}

document.querySelector(".prev-btn").addEventListener("click", function() {
    if (currentPage > 1) {
        currentPage--;
        showPage(currentPage);
    }
});

document.querySelector(".next-btn").addEventListener("click", function() {
    let allRows = Array.from(document.querySelectorAll("#table-body tr"));
    let filteredRows = allRows.filter(row => row.dataset.match !== "false");
    let totalPages = Math.ceil(filteredRows.length / rowsPerPage) || 1;
    if (currentPage < totalPages) {
        currentPage++;
        showPage(currentPage);
    }
});

window.addEventListener("load", function() {
    document.querySelectorAll("#table-body tr").forEach(row => {
        row.dataset.match = "true";
    });
    showPage(currentPage);
});
</script>
{% endblock %}